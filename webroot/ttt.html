<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tic-Tac-Toe</title>
</head>
<body>
	
  <h1>Welcome to Tic-Tac-Toe</h1>
	
  <fieldset>
	<legend>Games Management</legend>
 	<button id="createB">New Game</button>
  	<p id="createGameStatus"></p>
  </fieldset>
  <br>
  <fieldset>
  	<legend>User Management</legend>
  	<label for="userName">User name:</label>
  	<input type="text" id="userName" name="userName" value="my-player" required />
  	<button id="registerB">Register</button>
  	<p id="registerUserStatus"></p>
  </fieldset>
  <br>
  <fieldset>
  	<legend>Joining a Game</legend>
	<label for="userId">User id:</label>
	<input type="text" id="userId" name="userId" value="user-1" required />
	<label for="gameId">Game id:</label>
	<input type="text" id="gameId" name="gameId" value="game-1" required />
	<label for="symbol">Symbol:</label>
	<input type="text" id="symbol" name="symbol" value="cross" required />
	<button id="joinB">Join</button>  
	<p id="joinStatus"></p>
  </fieldset>
  <br>
  <fieldset id="playBox">
	<legend>Playing the Game</legend>
	<p id="playStatus"></p>
	<label for="x">x:</label>
	<input type="number" id="x" name="x" min="0" max="2" value="0" />
	<label for="y">y:</label>
	<input type="number" id="y" name="y" min="0" max="2" value="0" />
	<button id="moveB">Move</button>
	<br>
	<br>
	<label for="events">Game events</label>
	<br>
	<textarea id="events" name="events" rows="10" cols="80">
	</textarea>
  </fieldset>

      
  <script>
	document.getElementById("playBox").disabled = true;
	document.getElementById('createB').addEventListener('click', createGame);
	document.getElementById('registerB').addEventListener('click', registerUser);
	document.getElementById('joinB').addEventListener('click', joinGame);
	document.getElementById('moveB').addEventListener('click', playGame);
	
	async function createGame() {
	  const status = document.getElementById('createGameStatus');
	  try {
	    const response = await fetch('/api/createGame', {
	      method: 'POST',
	    });

	    if (response.ok) {
		  const gameInfo = await response.json();
		  console.log(gameInfo);
		  status.textContent = 'Game created - game ID: ' + gameInfo.gameId;

	    } else {
	      const err = await response.text();
	      status.textContent = `Game creation failed failed: ${err}`;
	    }
	  } catch (error) {
	    status.textContent = `Network error: ${error}`;
	  }
	}

	async function registerUser() {
	  const userName = document.getElementById('userName').value.trim();
	  const status = document.getElementById('registerUserStatus');
	  try {
	    const response = await fetch('/api/registerUser', {
	      method: 'POST',
	      headers: {
	        'Content-Type': 'application/json'
	      },
	      body: JSON.stringify({ userName })
	    });

	    if (response.ok) {
		  const userInfo = await response.json();
		  status.textContent = 'User registered successfully - user ID: ' + userInfo.userId;

	    } else {
	      const err = await response.text();
	      status.textContent = `Registration failed: ${err}`;
	    }
	  } catch (error) {
	    status.textContent = `Network error: ${error}`;
	  }
	}
		
	async function joinGame()	{
		const userId = document.getElementById('userId').value.trim();
		const gameId = document.getElementById('gameId').value.trim();
		const symbol = document.getElementById('symbol').value.trim();
		const status = document.getElementById('joinStatus');
		const playStatus = document.getElementById('playStatus');
		const events = document.getElementById('events');

		try {
			const response = await fetch('/api/joinGame', {
				method: 'POST',
			    headers: {
			        'Content-Type': 'application/json'
			    },
			    body: JSON.stringify({ userId, gameId, symbol })
			});

			if (response.ok) {
				const joinInfo = await response.json();
				
				if (joinInfo.result == 'accepted'){
					status.textContent = 'User ' + userId + ' joining the game ' + gameId + ' with symbol: ' + symbol;

					/* to complete the joining stage, a websocket to receive the game events must be created */
							  
					ws = new WebSocket('ws://' + location.host + '/api/events');

					/* when the connection is established, send a first message with the gameId */
					ws.addEventListener('open', () => {
						ws.send('{ "gameId": "' + gameId + '" }');
						status.textContent = 'Game joined';

						playStatus.textContent = 'Waiting another player to join...';
					});

					events.value = '';
					
					/* receive all events for this game and process them */				
					ws.addEventListener('message', (evt) => {
				  		handleServerEvent(JSON.parse(evt.data));
					});
				
				} else {
					status.textContent = `Join denied.`;
				}
			} else {
				const err = await response.text();
			    status.textContent = `Join failed: ${err}`;
			}
		} catch (error) {
		    status.textContent = `Network error: ${error}`;
		}
	}
		
	async function playGame()	{
	  	const userId = document.getElementById('userId').value.trim();
	  	const gameId = document.getElementById('gameId').value.trim();
	  	const symbol = document.getElementById('symbol').value.trim();
	  	const status = document.getElementById('playStatus');
	  	const x = document.getElementById('x').value;
	  	const y = document.getElementById('y').value;
		      
	  	try {
			const response = await fetch('/api/makeAMove', {
				method: 'POST',
			  	headers: {
			  		'Content-Type': 'application/json'
			  	},
			  	body: JSON.stringify({ userId, gameId, symbol, x, y })
			});

			if (response.ok) {
				const moveRes = await response.json();
			  	if (moveRes.result == 'accepted'){
					status.textContent = 'Move accepted';
				} else {
					status.textContent = 'Invalid move';
				}
			 } else {
			 	const err = await response.text();
				status.textContent = `Network error: ${err}`;
			 }
		} catch (error) {
		  	  status.textContent = `Network error: ${error}`;
		}
    }
	
	/*
	 *
	 * Handling game events notified by the back end.
	 *
	 */
	function handleServerEvent(evt){
		const events = document.getElementById('events');
		const status = document.getElementById('playStatus');
		const symbol = document.getElementById('symbol').value.trim();
		const opponentSymbol = symbol == 'cross' ? 'circle' : 'cross';
		const moveButton = document.getElementById("moveB");
		const playBox = document.getElementById("playBox");
		
		try {
			console.log(evt); 
			if (evt.event == 'game-started'){
				
				/* players can play now */
				
				playBox.disabled = false;				
				if (symbol == 'cross'){
					status.textContent = "Let's play! It's your turn";
					moveButton.disabled = false;
				} else {
					status.textContent = "Let's play! It's your opponent turn.";
					moveButton.disabled = true;
				}									
			} else if (evt.event == 'new-move'){
				
				/* new move */
				
				events.value += evt.symbol + ' in (' + evt.x + ',' + evt.y + ')\n';
				if (evt.symbol == symbol){
					status.textContent = "It's your opponent turn.";						
					moveButton.disabled = true;
				} else {
					status.textContent = "it's your turn.";	
					moveButton.disabled = false;
				}
			} else if (evt.event == 'game-ended'){
				
				/* end of the game */
				moveButton.disabled = true;
				 
				if (evt.winner == symbol){
					events.value += 'Game ended - You won.';
				} else if (evt.winner == opponentSymbol) {
					events.value += 'Game ended - You lose.';
				} else {
					events.value += 'Game ended - Tie.';
				}
			}
		} catch (e) {
			log('WS message parse error: ' + e.message);
		}
	}	
	
  </script>
</body>
</html>
